<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Plan Fit</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Plan Fit">
  <link rel="apple-touch-icon" href="icon-192x192.png"> 
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f8f9fa;
      --card: #ffffff;
      --primary: #7ba4c4;
      --accent: #aac6b8;
      --text: #333333;
      --success: #28a745;
      --danger: #dc3545;
      --border: #e0e0e0;
      --input-bg: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --font-family: 'Inter', sans-serif;
    }

    body.dark-mode {
      --bg: #1a1a2e;
      --card: #20203a;
      --primary: #8aafff;
      --accent: #5e8b7e;
      --text: #e0e0e0;
      --success: #4CAF50;
      --danger: #f44336;
      --border: #44445c;
      --input-bg: #2a2a40;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    h1, h2 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 20px;
    }

    h2 {
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
      margin-top: 30px;
    }

    .section {
      margin-bottom: 25px;
      padding: 15px;
      background-color: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--primary);
    }

    input[type="number"],
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: calc(100% - 20px);
      padding: 12px 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background-color: var(--input-bg);
      color: var(--text);
      font-family: var(--font-family);
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      outline: none;
    }

    button {
      background-color: var(--primary);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
      display: inline-block;
      width: auto;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    button:hover {
      background-color: #6a95b5;
    }

    button.danger {
      background-color: var(--danger);
    }

    button.danger:hover {
      background-color: #c82333;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-top: 20px;
    }

    .chart-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chart-controls label {
      margin-bottom: 0;
      white-space: nowrap;
    }

    .exercise-list, .weight-list {
      list-style: none;
      padding: 0;
    }

    .exercise-list li, .weight-list li {
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .exercise-list li .exercise-info {
      flex-grow: 1;
    }

    .exercise-list li .exercise-actions {
      display: flex;
      gap: 5px;
    }

    .exercise-list li span {
      font-weight: 600;
      color: var(--primary);
    }

    .current-day-exercises {
        margin-top: 15px;
        font-size: 1.1em;
    }

    .current-day-exercises p {
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }

    .current-day-exercises p input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
    }

    .current-day-exercises h3 {
        color: var(--accent);
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: var(--card);
        min-width: 160px;
        box-shadow: var(--shadow);
        z-index: 1;
        border-radius: 8px;
        overflow: hidden;
        right: 0; /* Align to the right */
    }

    .dropdown-content a {
        color: var(--text);
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: var(--border);
    }

    .menu-icon {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--primary);
        padding: 5px 10px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    .menu-icon:hover {
        background-color: var(--border);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 10px 0;
      border-bottom: 2px solid var(--primary);
    }

    header h1 {
      margin: 0;
      flex-grow: 1;
      text-align: center;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #darkModeToggle {
      background-color: var(--accent);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 0.9rem;
      margin-right: 10px;
    }

    #cameraInput {
        display: none;
    }

    #photoDisplay {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-top: 15px;
        display: block; /* Ocultar si no hay imagen */
        margin-left: auto;
        margin-right: auto;
        box-shadow: var(--shadow);
    }

    .photo-section {
        text-align: center;
    }

    #bmiDisplay {
        margin-top: 15px;
        font-size: 1.1em;
        font-weight: 600;
        text-align: center;
        padding: 10px;
        border-radius: 8px;
        background-color: var(--bg);
        border: 1px solid var(--border);
    }

    #bmiDisplay.normal {
        color: var(--success);
    }
    #bmiDisplay.underweight, #bmiDisplay.overweight, #bmiDisplay.obese {
        color: var(--danger);
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .container {
        padding: 15px;
      }
      button {
        width: 100%;
        margin-right: 0;
      }
      .button-group {
        flex-direction: column;
        align-items: stretch;
      }
      .header-actions {
        flex-direction: column;
        align-items: flex-end;
      }
      header h1 {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Mi Plan Fit</h1>
      <div class="header-actions">
        <button id="darkModeToggle">Modo Oscuro</button>
        <div class="dropdown">
          <button class="menu-icon" id="dropdownBtn">☰</button>
          <div class="dropdown-content" id="myDropdown">
            <a href="#" id="editPlanBtn">Editar Plan Semanal</a>
            <a href="#" id="resetAppBtn">Resetear App</a>
          </div>
        </div>
      </div>
    </header>

    <div class="section">
      <h2>Plan de Entrenamiento Diario</h2>
      <div class="button-group">
        <button id="prevDayBtn">Día Anterior</button>
        <button id="nextDayBtn">Día Siguiente</button>
      </div>
      <p>Día actual: <span id="currentDayDisplay">Cargando...</span></p>
      <div id="currentDayExercises" class="current-day-exercises">
        </div>
      <div class="form-group">
        <label for="exerciseName">Nombre del Ejercicio:</label>
        <input type="text" id="exerciseName" placeholder="Ej. Sentadilla" />
        <label for="exerciseSets">Series:</label>
        <input type="number" id="exerciseSets" placeholder="Ej. 3" min="1"/>
        <label for="exerciseReps">Repeticiones:</label>
        <input type="number" id="exerciseReps" placeholder="Ej. 10" min="1"/>
        <label for="exerciseWeight">Peso (kg):</label>
        <input type="number" id="exerciseWeight" placeholder="Ej. 50" step="0.1"/>
        <label for="exerciseNotes">Notas:</label>
        <textarea id="exerciseNotes" placeholder="Observaciones (ej. 'RPE 8', 'fácil', 'fallo')"></textarea>
      </div>
      <button id="addExerciseBtn">Añadir Ejercicio a Sesión</button>
      <button id="finishDayBtn">Finalizar Día de Entrenamiento</button>
    </div>

    <div class="section">
      <h2>Historial de Sesiones</h2>
      <div class="form-group">
        <label for="exerciseHistoryDropdown">Seleccionar Ejercicio:</label>
        <select id="exerciseHistoryDropdown">
          <option value="">Selecciona un ejercicio para ver su historial</option>
        </select>
      </div>
      <div id="exerciseHistoryDisplay">
        </div>
    </div>

    <div class="section">
      <h2>Seguimiento de Peso e IMC</h2>
      <div class="form-group">
        <label for="userHeight">Altura (metros):</label>
        <input type="number" id="userHeight" placeholder="Ej. 1.75" step="0.01" min="0.1" />
      </div>
      <div class="form-group">
        <label for="currentWeight">Peso actual (kg):</label>
        <input type="number" id="currentWeight" placeholder="Ej. 75.5" step="0.1" />
      </div>
      <button id="addWeightBtn">Registrar Peso</button>
      <div id="bmiDisplay">
        </div>
      <div class="chart-container">
        <canvas id="weightChart"></canvas>
      </div>
      <h3>Historial de Pesos:</h3>
      <ul id="weightHistoryList" class="weight-list">
        </ul>
    </div>

    <div class="section">
      <h2>Progreso en Ejercicios (Gráfico)</h2>
      <div class="chart-controls">
        <label for="exerciseChartSelect">Seleccionar Ejercicio:</label>
        <select id="exerciseChartSelect">
          <option value="">Seleccione un ejercicio</option>
        </select>
        <label for="exerciseChartMetric">Métrica:</label>
        <select id="exerciseChartMetric">
          <option value="weight">Peso</option>
          <option value="reps">Repeticiones</option>
          <option value="sets">Series</option>
        </select>
      </div>
      <div class="chart-container">
        <canvas id="exerciseChart"></canvas>
      </div>
    </div>

    <div class="section photo-section">
      <h2>Seguimiento Visual</h2>
      <input type="file" id="cameraInput" accept="image/*" capture="environment">
      <button onclick="document.getElementById('cameraInput').click();">Tomar Foto de Progreso</button>
      <img id="photoDisplay" src="#" alt="Foto de Progreso" style="display: none;">
      <button id="clearPhotoBtn" class="danger" style="display: none;">Eliminar Última Foto</button>
    </div>

  </div>

  <script>
    // --- Variables Globales ---
    let planEntrenamientoIndex = {}; // Almacena el plan de entrenamiento semanal
    let currentDay = 0; // Índice del día actual (0 para Lunes, 1 para Martes, etc.)
    let ejerciciosSesiones = []; // Historial de ejercicios completados (permanente)
    let dailySessionExercises = []; // Ejercicios añadidos en la sesión actual (temporal)
    let pesos = []; // Historial de pesos registrados
    let userHeight = null; // Altura del usuario en metros
    let weightChartInstance = null; // Instancia del gráfico de peso
    let exerciseChartInstance = null; // Instancia del gráfico de ejercicio

    // --- Selectores DOM ---
    const currentDayDisplay = document.getElementById('currentDayDisplay');
    const currentDayExercisesDiv = document.getElementById('currentDayExercises');
    const addExerciseBtn = document.getElementById('addExerciseBtn');
    const finishDayBtn = document.getElementById('finishDayBtn');
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');
    const exerciseNameInput = document.getElementById('exerciseName');
    const exerciseSetsInput = document.getElementById('exerciseSets');
    const exerciseRepsInput = document.getElementById('exerciseReps');
    const exerciseWeightInput = document.getElementById('exerciseWeight');
    const exerciseNotesInput = document.getElementById('exerciseNotes');
    const userHeightInput = document.getElementById('userHeight');
    const currentWeightInput = document.getElementById('currentWeight');
    const addWeightBtn = document.getElementById('addWeightBtn');
    const weightHistoryList = document.getElementById('weightHistoryList');
    const bmiDisplay = document.getElementById('bmiDisplay');
    const exerciseHistoryDropdown = document.getElementById('exerciseHistoryDropdown');
    const exerciseHistoryDisplay = document.getElementById('exerciseHistoryDisplay');
    const dropdownBtn = document.getElementById('dropdownBtn');
    const dropdownContent = document.getElementById('myDropdown');
    const editPlanBtn = document.getElementById('editPlanBtn');
    const resetAppBtn = document.getElementById('resetAppBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const cameraInput = document.getElementById('cameraInput');
    const photoDisplay = document.getElementById('photoDisplay');
    const clearPhotoBtn = document.getElementById('clearPhotoBtn');
    const exerciseChartSelect = document.getElementById('exerciseChartSelect');
    const exerciseChartMetric = document.getElementById('exerciseChartMetric');

    // --- Funciones de Utilidad ---

    // Función auxiliar para ocultar el dropdown después de una acción
    function hideDropdown() {
        dropdownContent.style.display = "none";
    }

    // Guardar datos en localStorage
    function savePlan() {
        localStorage.setItem("planEntrenamiento", JSON.stringify(planEntrenamientoIndex));
    }

    function saveEjerciciosSesiones() {
        localStorage.setItem("ejercicios_sesiones", JSON.stringify(ejerciciosSesiones));
    }

    function savePesos() {
        localStorage.setItem("peso_historial", JSON.stringify(pesos));
    }

    function saveUserHeight() {
        localStorage.setItem("user_height", JSON.stringify(userHeight));
    }
    
    // Guardar los ejercicios temporales de la sesión actual
    function saveDailySessionExercises() {
        const today = new Date().toISOString().split('T')[0];
        const key = `daily_session_exercises_${today}_day${currentDay}`;
        localStorage.setItem(key, JSON.stringify(dailySessionExercises));
    }

    // Cargar los ejercicios temporales de la sesión actual
    function loadDailySessionExercises() {
        const today = new Date().toISOString().split('T')[0];
        const key = `daily_session_exercises_${today}_day${currentDay}`;
        dailySessionExercises = JSON.parse(localStorage.getItem(key)) || [];
    }


    // Cargar datos de localStorage
    function loadData() {
        planEntrenamientoIndex = JSON.parse(localStorage.getItem("planEntrenamiento")) || {};
        ejerciciosSesiones = JSON.parse(localStorage.getItem("ejercicios_sesiones")) || [];
        pesos = JSON.parse(localStorage.getItem("peso_historial")) || [];
        userHeight = JSON.parse(localStorage.getItem("user_height")) || null;
        if (userHeight) {
            userHeightInput.value = userHeight;
        }
    }

    // Alternar modo oscuro
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // Aplicar modo oscuro al cargar
    function applyDarkMode() {
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
    }

    // --- Funciones para el Plan de Entrenamiento ---

    // Cargar ejercicios para el día actual
    function cargarEjerciciosDias() {
        const daysOfWeek = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
        currentDayDisplay.textContent = daysOfWeek[currentDay];
        currentDayExercisesDiv.innerHTML = ''; // Limpiar ejercicios anteriores

        const dayKey = `day-${currentDay + 1}`;
        const dayPlan = planEntrenamientoIndex[dayKey];

        if (dayPlan && dayPlan.ejercicios && dayPlan.ejercicios.length > 0) {
            currentDayExercisesDiv.innerHTML = `<h3>${dayPlan.name || `Día ${currentDay + 1}`}</h3>`;
            dayPlan.ejercicios.forEach((ejercicio, index) => {
                const p = document.createElement('p');
                const checkboxId = `checkbox-dia-${currentDay + 1}-ejercicio-${index}`;
                // Mostrar detalles del ejercicio si están disponibles
                const exerciseDetails = ejercicio.sets && ejercicio.reps && ejercicio.weight !== undefined ?
                                        ` (${ejercicio.sets}x${ejercicio.reps} @ ${ejercicio.weight}kg)` : '';
                p.innerHTML = `<input type="checkbox" id="${checkboxId}" data-day="${currentDay + 1}" data-exercise-name="${ejercicio.name}" />
                               <label for="${checkboxId}">${ejercicio.name}${exerciseDetails}</label>`;
                currentDayExercisesDiv.appendChild(p);
            });
        } else {
            currentDayExercisesDiv.innerHTML = `<p>No hay ejercicios definidos para el ${daysOfWeek[currentDay]}. Puedes editarlos en "Editar Plan Semanal".</p>`;
        }
        markCompletedDailyExercises(); // Marcar los checkboxes según dailySessionExercises
    }

    // Marcar los checkboxes de los ejercicios ya añadidos a la sesión temporal
    function markCompletedDailyExercises() {
        document.querySelectorAll('#currentDayExercises input[type="checkbox"]').forEach(checkbox => {
            const exerciseName = checkbox.dataset.exerciseName;
            const isCompleted = dailySessionExercises.some(ej => ej.name === exerciseName);
            checkbox.checked = isCompleted;
            // Deshabilitar el checkbox si ya está marcado para evitar desmarcar manualmente
            checkbox.disabled = isCompleted;
        });
    }

    // Reiniciar los ejercicios temporales para el día actual y los checkboxes
    function resetDailySession() {
        dailySessionExercises = [];
        const today = new Date().toISOString().split('T')[0];
        const key = `daily_session_exercises_${today}_day${currentDay}`;
        localStorage.removeItem(key);
        cargarEjerciciosDias(); // Recargar para limpiar los checks
    }

    // --- Event Listeners para Navegación de Días ---
    prevDayBtn.addEventListener('click', () => {
        currentDay = (currentDay - 1 + 7) % 7; // Ir al día anterior, ciclando
        localStorage.setItem("currentDayIndex", currentDay); // Guardar el día actual
        resetDailySession(); // Resetear sesión temporal al cambiar de día
    });

    nextDayBtn.addEventListener('click', () => {
        currentDay = (currentDay + 1) % 7; // Ir al día siguiente, ciclando
        localStorage.setItem("currentDayIndex", currentDay); // Guardar el día actual
        resetDailySession(); // Resetear sesión temporal al cambiar de día
    });

    // --- Añadir Ejercicio a la Sesión Actual ---
    addExerciseBtn.addEventListener('click', () => {
        const name = exerciseNameInput.value.trim();
        const sets = parseInt(exerciseSetsInput.value);
        const reps = parseInt(exerciseRepsInput.value);
        const weight = parseFloat(exerciseWeightInput.value);
        const notes = exerciseNotesInput.value.trim();

        if (!name) {
            alert("Por favor, introduce el nombre del ejercicio.");
            return;
        }
        if (isNaN(sets) || sets <= 0) {
            alert("Por favor, introduce un número válido de series (mayor que 0).");
            return;
        }
        if (isNaN(reps) || reps <= 0) {
            alert("Por favor, introduce un número válido de repeticiones (mayor que 0).");
            return;
        }
        if (isNaN(weight) || weight < 0) {
            alert("Por favor, introduce un peso válido (mayor o igual a 0).");
            return;
        }

        const newExercise = {
            date: new Date().toISOString().split('T')[0], // Formato YYYY-MM-DD
            dayIndex: currentDay,
            name: name,
            sets: sets,
            reps: reps,
            weight: weight,
            notes: notes
        };

        // Añadir a la sesión temporal
        // Si el ejercicio ya fue añadido, se actualiza, si no, se añade
        const existingIndex = dailySessionExercises.findIndex(ej => ej.name === name);
        if (existingIndex > -1) {
            dailySessionExercises[existingIndex] = newExercise;
        } else {
            dailySessionExercises.push(newExercise);
        }
        saveDailySessionExercises(); // Guardar la sesión temporal

        // Marcar el checkbox correspondiente y deshabilitarlo
        const checkbox = document.querySelector(`input[type="checkbox"][data-exercise-name="${name}"]`);
        if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
        }
        
        alert('Ejercicio añadido/actualizado a la sesión actual!');
        
        // Limpiar campos para el siguiente ejercicio
        exerciseNameInput.value = '';
        exerciseSetsInput.value = '';
        exerciseRepsInput.value = '';
        exerciseWeightInput.value = '';
        exerciseNotesInput.value = '';

        // NO actualizar gráficos/historial aquí. Se hará en "Finalizar Día".
    });

    // --- Finalizar Día de Entrenamiento ---
    finishDayBtn.addEventListener('click', () => {
        if (dailySessionExercises.length === 0) {
            alert("No hay ejercicios registrados en la sesión actual para finalizar.");
            return;
        }

        // Añadir todos los ejercicios de la sesión temporal al historial permanente
        ejerciciosSesiones.push(...dailySessionExercises);
        saveEjerciciosSesiones(); // Guardar el historial permanente

        // Limpiar y resetear la sesión temporal para el siguiente día/uso
        resetDailySession(); 
        
        alert('Día de entrenamiento finalizado! Se han guardado tus progresos.');
        
        // Limpiar campos de entrada de ejercicio
        exerciseNameInput.value = '';
        exerciseSetsInput.value = '';
        exerciseRepsInput.value = '';
        exerciseWeightInput.value = '';
        exerciseNotesInput.value = '';

        // Actualizar los dropdowns y gráficos
        populateExerciseChartDropdown();
        populateExerciseHistoryDropdown();
        // Llamar a updateExerciseChart() y updateWeightChart() explícitamente si se desea que se muestre el último progreso automáticamente.
        // Opcional: Si quieres que el gráfico de progreso se actualice automáticamente al finalizar el día con el último ejercicio registrado:
        // if (ejerciciosSesiones.length > 0) {
        //     exerciseChartSelect.value = ejerciciosSesiones[ejerciciosSesiones.length - 1].name;
        //     updateExerciseChart();
        // }
    });

    // --- Funciones para Historial de Ejercicios ---

    // Llenar el dropdown con todos los ejercicios registrados
    function populateExerciseHistoryDropdown() {
        exerciseHistoryDropdown.innerHTML = '<option value="">Selecciona un ejercicio para ver su historial</option>';
        const uniqueExercises = [...new Set(ejerciciosSesiones.map(ej => ej.name))];
        uniqueExercises.sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            exerciseHistoryDropdown.appendChild(option);
        });
    }

    // Mostrar el historial de un ejercicio seleccionado
    exerciseHistoryDropdown.addEventListener('change', () => {
        const selectedExerciseName = exerciseHistoryDropdown.value;
        exerciseHistoryDisplay.innerHTML = ''; // Limpiar antes de mostrar

        if (selectedExerciseName) {
            const filteredHistory = ejerciciosSesiones
                .filter(ej => ej.name === selectedExerciseName)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Ordenar por fecha descendente

            if (filteredHistory.length > 0) {
                const ul = document.createElement('ul');
                ul.classList.add('exercise-list');
                filteredHistory.forEach(ej => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="exercise-info">
                            <strong>${ej.date}</strong><br>
                            Series: <span>${ej.sets}</span>, Reps: <span>${ej.reps}</span>, Peso: <span>${ej.weight}kg</span><br>
                            Notas: <em>${ej.notes || 'N/A'}</em>
                        </div>
                    `;
                    ul.appendChild(li);
                });
                exerciseHistoryDisplay.appendChild(ul);
            } else {
                exerciseHistoryDisplay.innerHTML = '<p>No hay historial para este ejercicio.</p>';
            }
        }
    });

    // --- Funciones para el Seguimiento de Peso e IMC ---

    // Calcular IMC
    function calculateBMI(weight, height) {
        if (weight > 0 && height > 0) {
            return (weight / (height * height)).toFixed(2);
        }
        return null;
    }

    // Interpretar IMC y mostrarlo
    function displayBMI() {
        const latestWeight = pesos.length > 0 ? pesos[pesos.length - 1].weight : null;
        const height = userHeight;

        bmiDisplay.className = ''; // Limpiar clases anteriores

        if (latestWeight && height) {
            const bmi = calculateBMI(latestWeight, height);
            let interpretation = '';
            let className = '';

            if (bmi < 18.5) {
                interpretation = 'Bajo peso';
                className = 'underweight';
            } else if (bmi >= 18.5 && bmi < 25) {
                interpretation = 'Peso normal';
                className = 'normal';
            } else if (bmi >= 25 && bmi < 30) {
                interpretation = 'Sobrepeso';
                className = 'overweight';
            } else {
                interpretation = 'Obesidad';
                className = 'obese';
            }
            bmiDisplay.innerHTML = `Tu IMC actual es: <strong>${bmi}</strong> (${interpretation}).`;
            bmiDisplay.classList.add(className);

             // Mensaje cualitativo sin dar asesoramiento médico o de peso
             if (className === 'normal') {
                bmiDisplay.innerHTML += '<br>Tu peso se encuentra en un rango saludable según el IMC.';
            } else {
                bmiDisplay.innerHTML += '<br>Considera que tu peso se encuentra fuera del rango saludable según el IMC.';
            }

        } else {
            bmiDisplay.textContent = 'Introduce tu altura y registra tu peso para calcular el IMC.';
        }
    }


    // Mostrar el historial de peso en la lista
    function displayPesoHistory() {
        weightHistoryList.innerHTML = '';
        // Mostrar los últimos 10 pesos, ordenados por fecha descendente
        const sortedPesos = [...pesos].sort((a, b) => new Date(b.date) - new Date(a.date));
        sortedPesos.slice(0, 10).forEach(entry => {
            const li = document.createElement('li');
            li.textContent = `${entry.date}: ${entry.weight} kg`;
            weightHistoryList.appendChild(li);
        });
    }

    // Evento al cambiar la altura
    userHeightInput.addEventListener('change', () => {
        const height = parseFloat(userHeightInput.value);
        if (isNaN(height) || height <= 0) {
            alert("Por favor, introduce una altura válida (en metros, mayor que 0).");
            userHeight = null; // Resetear altura si es inválida
            userHeightInput.value = '';
        } else {
            userHeight = height;
        }
        saveUserHeight();
        displayBMI(); // Actualizar IMC al cambiar la altura
    });


    // Añadir nuevo peso
    addWeightBtn.addEventListener('click', () => {
        const weight = parseFloat(currentWeightInput.value);
        const height = parseFloat(userHeightInput.value); // Obtener altura en el momento de registrar el peso

        if (isNaN(weight) || weight <= 0) {
            alert("Por favor, introduce un peso válido (mayor que 0).");
            return;
        }
        if (isNaN(height) || height <= 0) {
            alert("Por favor, introduce tu altura en metros para registrar el peso y calcular el IMC.");
            return;
        }

        // Asegurarse de que userHeight esté actualizado antes de guardar el peso
        userHeight = height;
        saveUserHeight();

        const date = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
        pesos.push({ date, weight });
        savePesos();
        displayPesoHistory();
        updateWeightChart(); // Actualizar gráfico al añadir nuevo peso
        displayBMI(); // Actualizar IMC al añadir nuevo peso
        currentWeightInput.value = ''; // Limpiar campo
    });

    // --- Gráficos con Chart.js ---

    // Gráfico de peso
    function updateWeightChart() {
        if (weightChartInstance) {
            weightChartInstance.destroy(); // Destruir instancia anterior si existe
        }

        // Ordenar pesos por fecha para el gráfico
        const sortedPesos = [...pesos].sort((a, b) => new Date(a.date) - new Date(b.date));
        const labels = sortedPesos.map(entry => entry.date);
        const data = sortedPesos.map(entry => entry.weight);

        const ctx = document.getElementById('weightChart').getContext('2d');
        weightChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Peso (kg)',
                    data: data,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text')
                        },
                        grid: {
                            color: getComputedStyle(document.body).getPropertyValue('--border')
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text')
                        },
                        grid: {
                            color: getComputedStyle(document.body).getPropertyValue('--border')
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: getComputedStyle(document.body).getPropertyValue('--text')
                        }
                    }
                }
            }
        });
    }

    // Llenar el select de ejercicios para el gráfico
    function populateExerciseChartDropdown() {
        exerciseChartSelect.innerHTML = '<option value="">Seleccione un ejercicio</option>';
        const uniqueExercises = [...new Set(ejerciciosSesiones.map(ej => ej.name))];
        uniqueExercises.sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            exerciseChartSelect.appendChild(option);
        });
    }

    // Gráfico de progreso de ejercicios
    function updateExerciseChart() {
        if (exerciseChartInstance) {
            exerciseChartInstance.destroy(); // Destruir instancia anterior si existe
        }

        const selectedExerciseName = exerciseChartSelect.value;
        const selectedMetric = exerciseChartMetric.value;

        if (!selectedExerciseName || !selectedMetric) {
            return; // No dibujar si no hay selección completa
        }

        const filteredData = ejerciciosSesiones
            .filter(ej => ej.name === selectedExerciseName)
            .sort((a, b) => new Date(a.date) - new Date(b.date)); // Ordenar por fecha

        const labels = filteredData.map(entry => entry.date);
        const data = filteredData.map(entry => entry[selectedMetric]);

        const ctx = document.getElementById('exerciseChart').getContext('2d');
        exerciseChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `${selectedMetric.charAt(0).toUpperCase() + selectedMetric.slice(1)} de ${selectedExerciseName}`,
                    data: data,
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text')
                        },
                        grid: {
                            color: getComputedStyle(document.body).getPropertyValue('--border')
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--text')
                        },
                        grid: {
                            color: getComputedStyle(document.body).getPropertyValue('--border')
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: getComputedStyle(document.body).getPropertyValue('--text')
                        }
                    }
                }
            }
        });
    }

    exerciseChartSelect.addEventListener('change', updateExerciseChart);
    exerciseChartMetric.addEventListener('change', updateExerciseChart);


    // --- Funciones para la Gestión de Fotos ---

    // Mostrar la última foto guardada
    function displayLastPhoto() {
        try {
            const lastPhoto = localStorage.getItem('last_progress_photo');
            if (lastPhoto) {
                photoDisplay.src = lastPhoto;
                photoDisplay.style.display = 'block';
                clearPhotoBtn.style.display = 'inline-block';
            } else {
                photoDisplay.style.display = 'none';
                clearPhotoBtn.style.display = 'none';
            }
        } catch (error) {
            console.error("Error al cargar la foto:", error);
            photoDisplay.style.display = 'none';
            clearPhotoBtn.style.display = 'none';
        }
    }

    // Manejar la captura de la foto
    cameraInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('last_progress_photo', e.target.result);
                displayLastPhoto();
            };
            reader.readAsDataURL(file);
        }
    });

    // Eliminar la foto guardada
    clearPhotoBtn.addEventListener('click', () => {
        if (confirm("¿Estás seguro de que quieres eliminar la última foto?")) {
            localStorage.removeItem('last_progress_photo');
            displayLastPhoto();
            alert("Foto eliminada.");
        }
    });

    // --- Funciones para el Menú Dropdown (Header) ---
    dropdownBtn.addEventListener('click', (event) => {
        dropdownContent.style.display = dropdownContent.style.display === "block" ? "none" : "block";
        event.stopPropagation(); // Evitar que el clic en el botón cierre el dropdown inmediatamente
    });

    // Cerrar el dropdown si se hace clic fuera
    window.addEventListener('click', (event) => {
        if (!event.target.matches('#dropdownBtn')) {
            hideDropdown();
        }
    });

    editPlanBtn.addEventListener('click', (event) => {
        event.preventDefault(); // Prevenir navegación por defecto
        hideDropdown();
        window.location.href = 'editar_dias.html'; // Navegar a la página de edición
    });

    resetAppBtn.addEventListener('click', (event) => {
        event.preventDefault(); // Prevenir navegación por defecto
        hideDropdown();
        if (confirm("¿Estás seguro de que quieres resetear la aplicación? Se eliminarán todos tus datos (plan de entrenamiento, historial de ejercicios, historial de peso, fotos y estado de los checkboxes). Esta acción no se puede deshacer.")) {
            localStorage.clear();
            alert("Aplicación reseteada. Recargando...");
            window.location.reload(); // Recargar la página para limpiar todo
        }
    });

    darkModeToggle.addEventListener('click', toggleDarkMode);

    // --- Inicialización al Cargar la Página ---
    document.addEventListener('DOMContentLoaded', () => {
        applyDarkMode(); // Aplicar el modo oscuro al inicio
        loadData(); // Cargar todos los datos
        
        // Cargar el plan de entrenamiento con valores por defecto si no existe
        if (Object.keys(planEntrenamientoIndex).length === 0) {
            planEntrenamientoIndex['day-1'] = { name: "Día 1 - Full Body Fuerza", ejercicios: [
                { name: "Peso muerto rumano", sets: 3, reps: 8, weight: 60 },
                { name: "Dominadas asistidas", sets: 3, reps: 10, weight: 0 },
                { name: "Press inclinado", sets: 3, reps: 10, weight: 40 },
                { name: "Plancha", sets: 3, reps: 60, weight: 0 }, // reps para segundos
                { name: "Bird-dogs", sets: 3, reps: 12, weight: 0 }
            ]};
            planEntrenamientoIndex['day-2'] = { name: "Día 2 - Hipertrofia + Core", ejercicios: [
                { name: "Sentadilla goblet", sets: 3, reps: 12, weight: 20 },
                { name: "Remo con barra", sets: 3, reps: 10, weight: 30 },
                { name: "Z-Press", sets: 3, reps: 8, weight: 15 },
                { name: "Plancha reach", sets: 3, reps: 45, weight: 0 }, // reps para segundos
                { name: "Hollow hold", sets: 3, reps: 30, weight: 0 } // reps para segundos
            ]};
            planEntrenamientoIndex['day-3'] = { name: "Día 3 - Cardio + Core", ejercicios: [
                { name: "Caminata inclinada", sets: 1, reps: 30, weight: 0, notes: "minutos" },
                { name: "Abdominales", sets: 3, reps: 15, weight: 0 },
                { name: "Movilidad", sets: 1, reps: 10, weight: 0, notes: "minutos" }
            ]};
            planEntrenamientoIndex['day-4'] = { name: "Día 4 - Descanso", ejercicios: [] };
            planEntrenamientoIndex['day-5'] = { name: "Día 5 - Tren Superior", ejercicios: [
                { name: "Press de hombros", sets: 3, reps: 10, weight: 25 },
                { name: "Remo con mancuernas", sets: 3, reps: 12, weight: 15 },
                { name: "Flexiones", sets: 3, reps: 10, weight: 0 }
            ]};
            planEntrenamientoIndex['day-6'] = { name: "Día 6 - Tren Inferior", ejercicios: [
                { name: "Sentadilla", sets: 3, reps: 8, weight: 50 },
                { name: "Peso muerto", sets: 3, reps: 6, weight: 70 },
                { name: "Zancadas", sets: 3, reps: 10, weight: 10 }
            ]};
            planEntrenamientoIndex['day-7'] = { name: "Día 7 - Actividad Ligera", ejercicios: [
                { name: "Yoga", sets: 1, reps: 45, weight: 0, notes: "minutos" },
                { name: "Caminata", sets: 1, reps: 60, weight: 0, notes: "minutos" }
            ]};
            savePlan(); // Guardar los valores por defecto
        }

        // Determinar el día actual basado en el día de la semana real si es la primera carga
        if (localStorage.getItem("currentDayIndex") === null) {
            const today = new Date();
            currentDay = (today.getDay() + 6) % 7; // 0=Domingo, 1=Lunes... a 0=Lunes, 1=Martes...
            localStorage.setItem("currentDayIndex", currentDay);
        } else {
            currentDay = parseInt(localStorage.getItem("currentDayIndex"));
        }
        
        loadDailySessionExercises(); // Cargar los ejercicios temporales para el día actual
        cargarEjerciciosDias(); // Cargar los ejercicios del plan diario y marcar checks
        
        displayPesoHistory(); // Cargar y mostrar el historial de peso
        updateWeightChart(); // Cargar gráfico de peso al inicio
        displayBMI(); // Mostrar IMC al inicio

        populateExerciseChartDropdown(); // Llenar el select de ejercicios para el gráfico
        populateExerciseHistoryDropdown(); // Llenar el select de historial de ejercicios
        
        displayLastPhoto(); // Mostrar la última foto guardada
        
        // Ya no necesitamos un event listener para los checkboxes individuales,
        // ya que su estado ahora se gestiona automáticamente al añadir ejercicios a la sesión.
    });

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker registrado con éxito:', registration);
          })
          .catch(error => {
            console.log('Fallo el registro del Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>