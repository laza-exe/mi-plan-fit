<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Plan Semanal</title>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f9fa;
            --card: #ffffff;
            --primary: #7ba4c4;
            --accent: #aac6b8;
            --text: #333333;
            --danger: #dc3545;
        }
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 1rem;
        }
        .section {
            background: var(--card);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        h1, h2, h3 {
            color: var(--primary);
        }
        input[type="text"], select {
            width: 100%;
            padding: 0.6rem;
            margin-bottom: 0.5rem;
            border-radius: 0.6rem;
            border: 1px solid #ccc;
            font-size: 1rem;
            box-sizing: border-box;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        ul li {
            background: #f1f1f1;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Permite que los botones bajen si no hay espacio */
        }
        ul li span[contenteditable="true"] {
            flex-grow: 1;
            margin-right: 0.5rem;
            min-width: 150px; /* Asegura espacio para editar */
            padding: 0.2rem;
            border: 1px solid transparent; /* Para simular input */
            border-radius: 4px;
        }
        ul li span[contenteditable="true"]:focus {
            border: 1px solid var(--primary);
            background-color: #e6f0f5;
        }
        .add-btn, .save-btn, .back-btn, .manage-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 0.6rem;
            cursor: pointer;
            font-weight: bold;
            margin-top: 1rem;
            width: 100%;
        }
        .delete-btn, .remove-day-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .add-btn:hover, .save-btn:hover, .manage-btn:hover {
            background-color: #6a92b0;
        }
        .delete-btn:hover, .remove-day-btn:hover {
            background-color: #c82333;
        }
        .back-btn {
            background: var(--accent);
            color: var(--text);
            margin-top: 1.5rem;
            border: 1px solid var(--primary);
        }
        .back-btn:hover {
            background-color: #9ab6a8;
        }
        .tab-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite que los botones de d√≠a se envuelvan */
            margin-bottom: 1rem;
            gap: 0.5rem; /* Espacio entre botones */
        }
        .tab-buttons button {
            flex-grow: 1; /* Permite que los botones crezcan */
            padding: 0.8rem;
            border: 1px solid #ccc;
            background: #eee;
            cursor: pointer;
            font-weight: bold;
            border-radius: 0.6rem; /* Bordes redondeados para cada bot√≥n */
            margin-bottom: 0;
            min-width: 80px; /* Ancho m√≠nimo para los botones de d√≠a */
        }
        .tab-buttons button.active {
            background: var(--primary);
            color: white;
        }
        .tab-content {
            border: 1px solid #ccc;
            padding: 1rem;
            border-radius: 0.6rem;
        }
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .add-from-master {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .add-from-master select {
            flex-grow: 1;
            margin-bottom: 0; /* Anula margen de input general */
        }
        .add-from-master button {
            width: auto;
            padding: 0.6rem 1rem;
            margin-top: 0; /* Anula margen de bot√≥n general */
        }
        /* Estilos para la secci√≥n de Master List */
        .master-list ul {
            max-height: 200px; /* Limita la altura del scroll */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 0.6rem;
            padding: 0.5rem;
            background-color: #f9f9f9;
        }
        .master-list li {
            background: none; /* Eliminar fondo de lista de ejercicios */
            border-bottom: 1px dashed #e0e0e0;
            margin-bottom: 0;
            border-radius: 0;
        }
        .master-list li:last-child {
            border-bottom: none;
        }
        .master-list li span {
            flex-grow: 1;
        }
        .master-list input[type="text"] {
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>‚úèÔ∏è Editar Plan Semanal</h1>

    <div class="section">
        <h2>üõ†Ô∏è Gesti√≥n de D√≠as de Entrenamiento</h2>
        <div id="dayTabsContainer" class="tab-buttons">
            </div>

        <div id="dayContentsContainer">
            </div>

        <input type="text" id="newDayName" placeholder="Ej: D√≠a 4 - Brazos">
        <button onclick="addDay()" class="add-btn">‚ûï A√±adir Nuevo D√≠a</button>
    </div>

    <div class="section">
        <h2>üìö Listado Maestro de Ejercicios</h2>
        <div class="master-list">
            <ul id="masterExerciseList">
                </ul>
            <input type="text" id="newMasterExercise" placeholder="A√±adir nuevo ejercicio maestro">
            <button onclick="addMasterExercise()" class="add-btn">‚ûï A√±adir a Listado Maestro</button>
            <button onclick="confirmClearMasterList()" class="delete-btn" style="width: auto; margin-left: auto;">üóëÔ∏è Borrar Listado Maestro</button>
        </div>
    </div>

    <button onclick="window.location.href='index.html'" class="back-btn">‚¨ÖÔ∏è Volver a Mi Plan Fit</button>

    <script>
        let planEntrenamiento = JSON.parse(localStorage.getItem("planEntrenamiento") || "{}");
        let masterExercises = JSON.parse(localStorage.getItem("masterExercises") || "[]");

        // Funciones para gestionar el Listado Maestro de Ejercicios
        function loadMasterExercises() {
            const ul = document.getElementById("masterExerciseList");
            ul.innerHTML = "";
            masterExercises.forEach((ej, index) => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <span contenteditable="true" onblur="updateMasterExercise(${index}, this.innerText)">${ej}</span>
                    <button class="delete-btn" onclick="deleteMasterExercise(${index})">üóë</button>
                `;
                ul.appendChild(li);
            });
        }

        function addMasterExercise() {
            const input = document.getElementById("newMasterExercise");
            const newEj = input.value.trim();
            if (newEj && !masterExercises.includes(newEj)) { // Evitar duplicados
                masterExercises.push(newEj);
                input.value = "";
                saveMasterExercises();
                loadMasterExercises();
            } else if (masterExercises.includes(newEj)) {
                alert("Ese ejercicio ya existe en el listado maestro.");
            }
        }

        function updateMasterExercise(index, newText) {
            newText = newText.trim();
            if (newText && masterExercises[index] !== undefined && !masterExercises.includes(newText)) {
                masterExercises[index] = newText;
                saveMasterExercises();
                loadMasterExercises(); // Recarga para ordenar y evitar duplicados visuales
            } else if (masterExercises.includes(newText) && masterExercises[index] !== newText) {
                alert("Ya existe un ejercicio con ese nombre.");
                loadMasterExercises(); // Recarga para volver al valor original
            } else if (!newText) {
                alert("El nombre del ejercicio no puede estar vac√≠o. Borra la entrada si no la quieres.");
                loadMasterExercises(); // Recarga para volver al valor original
            }
        }

        function deleteMasterExercise(index) {
            if (confirm(`¬øEst√°s seguro de que quieres borrar "${masterExercises[index]}" del listado maestro?`)) {
                masterExercises.splice(index, 1);
                saveMasterExercises();
                loadMasterExercises();
            }
        }

        function saveMasterExercises() {
            // Asegurarse de que no haya duplicados y ordenar antes de guardar
            masterExercises = [...new Set(masterExercises)].sort((a, b) => a.localeCompare(b));
            localStorage.setItem("masterExercises", JSON.stringify(masterExercises));
        }

        function confirmClearMasterList() {
            if (confirm("¬øEst√°s seguro de que quieres borrar TODO el listado maestro de ejercicios? Esta acci√≥n es irreversible.")) {
                masterExercises = [];
                saveMasterExercises();
                loadMasterExercises();
                alert("Listado maestro borrado.");
            }
        }

        // Funciones para gestionar los D√≠as de Entrenamiento
        let activeDayId = null; // Para saber qu√© d√≠a est√° activo

        function generateDayId(name) {
            // Genera un ID √∫nico basado en el nombre y un timestamp para evitar colisiones
            return name.toLowerCase().replace(/\s/g, '-') + '-' + Date.now();
        }

        function loadDays() {
            const dayTabsContainer = document.getElementById("dayTabsContainer");
            const dayContentsContainer = document.getElementById("dayContentsContainer");
            dayTabsContainer.innerHTML = "";
            dayContentsContainer.innerHTML = "";

            const dayKeys = Object.keys(planEntrenamiento).sort((a,b) => {
                // Ordenar por el n√∫mero de d√≠a si el formato es "d√≠a X - ..."
                const numA = parseInt(a.match(/day-(\d+)/)?.[1]);
                const numB = parseInt(b.match(/day-(\d+)/)?.[1]);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b); // Orden alfab√©tico si no es un d√≠a numerado
            });

            if (dayKeys.length === 0) {
                dayContentsContainer.innerHTML = "<p>No hay d√≠as de entrenamiento. A√±ade uno para empezar.</p>";
                activeDayId = null;
                return;
            }

            dayKeys.forEach(dayId => {
                const dayData = planEntrenamiento[dayId];

                // Crear bot√≥n de pesta√±a para el d√≠a
                const button = document.createElement("button");
                button.textContent = dayData.name;
                button.id = `tab-${dayId}`;
                button.onclick = () => showDay(dayId);
                dayTabsContainer.appendChild(button);

                // Crear contenedor de contenido para el d√≠a
                const contentDiv = document.createElement("div");
                contentDiv.id = `content-${dayId}`;
                contentDiv.classList.add("tab-content");
                contentDiv.style.display = 'none'; // Ocultar por defecto

                contentDiv.innerHTML = `
                    <div class="day-header">
                        <h3>${dayData.name}</h3>
                        <button class="remove-day-btn" onclick="confirmRemoveDay('${dayId}', '${dayData.name}')">üóëÔ∏è Borrar D√≠a</button>
                    </div>
                    <ul id="listaEjercicios-${dayId}"></ul>
                    <div class="add-from-master">
                        <select id="selectEjercicioMaster-${dayId}">
                            <option value="">Selecciona del listado maestro...</option>
                            ${masterExercises.map(ej => `<option value="${ej}">${ej}</option>`).join('')}
                        </select>
                        <button onclick="addEjercicioFromMaster('${dayId}')" class="add-btn" style="width: auto;">‚ûï</button>
                    </div>
                    <input type="text" id="nuevoEjercicio-${dayId}" placeholder="A√±adir nuevo ejercicio manual">
                    <button onclick="addEjercicio('${dayId}')" class="add-btn">‚ûï A√±adir Ejercicio Manual</button>
                    <button onclick="saveDayChanges('${dayId}')" class="save-btn">üíæ Guardar Cambios para ${dayData.name}</button>
                `;
                dayContentsContainer.appendChild(contentDiv);
            });

            // Mostrar el primer d√≠a o el √∫ltimo activo
            if (!activeDayId || !planEntrenamiento[activeDayId]) {
                activeDayId = dayKeys[0];
            }
            showDay(activeDayId);
        }

        function showDay(dayId) {
            // Ocultar pesta√±a anterior
            if (activeDayId && document.getElementById(`content-${activeDayId}`)) {
                document.getElementById(`content-${activeDayId}`).style.display = 'none';
                document.getElementById(`tab-${activeDayId}`).classList.remove('active');
            }

            activeDayId = dayId; // Establecer el nuevo d√≠a activo

            // Mostrar nueva pesta√±a
            document.getElementById(`content-${activeDayId}`).style.display = 'block';
            document.getElementById(`tab-${activeDayId}`).classList.add('active');

            // Cargar ejercicios espec√≠ficos para el d√≠a activo
            loadEjerciciosForDay(activeDayId);
        }

        function addDay() {
            const newDayNameInput = document.getElementById("newDayName");
            let newDayName = newDayNameInput.value.trim();

            if (!newDayName) {
                alert("Por favor, introduce un nombre para el nuevo d√≠a.");
                return;
            }

            // Generar un ID incremental si el nombre es "D√≠a X"
            let dayId;
            const existingDayNumbers = Object.keys(planEntrenamiento)
                                        .map(id => parseInt(id.match(/day-(\d+)/)?.[1]))
                                        .filter(num => !isNaN(num));
            const nextDayNumber = existingDayNumbers.length > 0 ? Math.max(...existingDayNumbers) + 1 : 1;

            if (newDayName.toLowerCase().startsWith("d√≠a") || newDayName.toLowerCase().startsWith("dia")) {
                 dayId = `day-${nextDayNumber}`;
                 // Actualizar el nombre para que coincida si el usuario solo puso "D√≠a X"
                 if (!newDayName.toLowerCase().includes(nextDayNumber.toString())) {
                    newDayName = `D√≠a ${nextDayNumber}`;
                 }
            } else {
                dayId = generateDayId(newDayName);
            }
            
            // Comprobar si el nombre del d√≠a ya existe
            const nameExists = Object.values(planEntrenamiento).some(day => day.name === newDayName);
            if (nameExists) {
                alert(`Ya existe un d√≠a con el nombre "${newDayName}". Por favor, elige otro nombre.`);
                return;
            }

            planEntrenamiento[dayId] = {
                name: newDayName,
                ejercicios: []
            };
            savePlan();
            newDayNameInput.value = "";
            loadDays(); // Recarga todos los d√≠as para mostrar el nuevo
            showDay(dayId); // Muestra el nuevo d√≠a
        }

        function confirmRemoveDay(dayId, dayName) {
            if (confirm(`¬øEst√°s seguro de que quieres borrar el d√≠a "${dayName}" y todos sus ejercicios? Esta acci√≥n es irreversible.`)) {
                removeDay(dayId);
            }
        }

        function removeDay(dayId) {
            delete planEntrenamiento[dayId];
            savePlan();
            loadDays(); // Recarga todos los d√≠as

            // Si el d√≠a activo era el borrado, selecciona el primero disponible
            const dayKeys = Object.keys(planEntrenamiento);
            if (dayKeys.length > 0) {
                showDay(dayKeys[0]);
            } else {
                document.getElementById("dayContentsContainer").innerHTML = "<p>No hay d√≠as de entrenamiento. A√±ade uno para empezar.</p>";
                activeDayId = null;
            }
        }

        function loadEjerciciosForDay(dayId) {
            const ul = document.getElementById(`listaEjercicios-${dayId}`);
            if (!ul) return; // Asegurarse de que el UL existe
            ul.innerHTML = "";
            const currentEjercicios = planEntrenamiento[dayId] ? planEntrenamiento[dayId].ejercicios : [];

            currentEjercicios.forEach((ej, index) => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <span contenteditable="true" onblur="updateEjercicioForDay('${dayId}', ${index}, this.innerText)">${ej}</span>
                    <button class="delete-btn" onclick="deleteEjercicioForDay('${dayId}', ${index})">üóë</button>
                `;
                ul.appendChild(li);
            });
        }

        function addEjercicio(dayId) {
            const input = document.getElementById(`nuevoEjercicio-${dayId}`);
            const newEj = input.value.trim();
            if (newEj) {
                if (!planEntrenamiento[dayId]) {
                    planEntrenamiento[dayId] = { name: "Nuevo D√≠a", ejercicios: [] }; // Fallback si el d√≠a no existe
                }
                planEntrenamiento[dayId].ejercicios.push(newEj);
                input.value = "";
                loadEjerciciosForDay(dayId);
                savePlan();
            }
        }

        function addEjercicioFromMaster(dayId) {
            const select = document.getElementById(`selectEjercicioMaster-${dayId}`);
            const selectedExercise = select.value;
            if (selectedExercise) {
                if (!planEntrenamiento[dayId]) {
                    planEntrenamiento[dayId] = { name: "Nuevo D√≠a", ejercicios: [] };
                }
                if (!planEntrenamiento[dayId].ejercicios.includes(selectedExercise)) { // Evitar duplicados en el d√≠a
                    planEntrenamiento[dayId].ejercicios.push(selectedExercise);
                    loadEjerciciosForDay(dayId);
                    savePlan();
                } else {
                    alert("Este ejercicio ya est√° en la lista de este d√≠a.");
                }
                select.value = ""; // Resetear el selector
            } else {
                alert("Por favor, selecciona un ejercicio del listado maestro.");
            }
        }

        function updateEjercicioForDay(dayId, index, newText) {
            newText = newText.trim();
            if (planEntrenamiento[dayId] && planEntrenamiento[dayId].ejercicios[index] !== undefined) {
                if (newText) {
                    planEntrenamiento[dayId].ejercicios[index] = newText;
                } else {
                    alert("El nombre del ejercicio no puede estar vac√≠o. B√≥rralo si no lo necesitas.");
                    loadEjerciciosForDay(dayId); // Recargar para mostrar el valor original
                }
                savePlan();
            }
        }

        function deleteEjercicioForDay(dayId, index) {
            if (confirm(`¬øEst√°s seguro de que quieres borrar "${planEntrenamiento[dayId].ejercicios[index]}" de este d√≠a?`)) {
                planEntrenamiento[dayId].ejercicios.splice(index, 1);
                loadEjerciciosForDay(dayId);
                savePlan();
            }
        }

        function saveDayChanges(dayId) {
            // La funci√≥n updateEjercicioForDay y addEjercicio ya llaman a savePlan()
            // Esto es m√°s bien un bot√≥n de confirmaci√≥n visual para el usuario
            savePlan();
            alert(`Cambios para ${planEntrenamiento[dayId].name} guardados.`);
        }

        // Esta funci√≥n es para asegurar que index.html tenga acceso a los ejercicios de los 3 d√≠as por defecto
        function updateIndexHtmlExercises() {
            const defaultDays = { // Mapping for d1, d2, d3 in index.html
                d1: Object.values(planEntrenamiento).find(day => day.name.toLowerCase().includes("d√≠a 1") || day.name.toLowerCase().includes("dia 1")),
                d2: Object.values(planEntrenamiento).find(day => day.name.toLowerCase().includes("d√≠a 2") || day.name.toLowerCase().includes("dia 2")),
                d3: Object.values(planEntrenamiento).find(day => day.name.toLowerCase().includes("d√≠a 3") || day.name.toLowerCase().includes("dia 3"))
            };

            const exercisesForIndex = {};
            if (defaultDays.d1) exercisesForIndex.d1 = defaultDays.d1.ejercicios;
            if (defaultDays.d2) exercisesForIndex.d2 = defaultDays.d2.ejercicios;
            if (defaultDays.d3) exercisesForIndex.d3 = defaultDays.d3.ejercicios;
            
            localStorage.setItem("ejerciciosDias", JSON.stringify(exercisesForIndex));
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Valores por defecto si no existe ning√∫n d√≠a
            if (Object.keys(planEntrenamiento).length === 0) {
                planEntrenamiento['day-1'] = { name: "D√≠a 1 - Full Body Fuerza", ejercicios: ["Peso muerto rumano", "Dominadas asistidas", "Press inclinado", "Plancha", "Bird-dogs"] };
                planEntrenamiento['day-2'] = { name: "D√≠a 2 - Hipertrofia + Core", ejercicios: ["Sentadilla goblet", "Remo con barra", "Z-Press", "Plancha reach", "Hollow hold"] };
                planEntrenamiento['day-3'] = { name: "D√≠a 3 - Cardio + Core", ejercicios: ["Caminata inclinada", "2 abdominales a elecci√≥n", "Movilidad 10 min"] };
                savePlan();
            }

            // Valores por defecto para el listado maestro si no existe
            if (masterExercises.length === 0) {
                masterExercises = [
                    "Sentadilla", "Peso Muerto", "Press Banca", "Press Militar", "Remo con Barra",
                    "Dominadas", "Fondos", "Curl de B√≠ceps", "Extensi√≥n de Tr√≠ceps", "Press Inclinado",
                    "Sentadilla Goblet", "Zancadas", "Prensa de Piernas", "Extensiones de Cu√°driceps",
                    "Curl Femoral", "Elevaciones Laterales", "P√°jaros", "Face Pull", "Plancha",
                    "Crunch", "Elevaci√≥n de Piernas", "Hollow Hold", "Bird-dog", "Caminata Inclinada",
                    "Burpees", "Saltos de Caja", "Sentadilla B√∫lgara", "Hip Thrust", "Press Franc√©s"
                ];
                saveMasterExercises();
            }

            loadMasterExercises(); // Carga el listado maestro
            loadDays(); // Carga todos los d√≠as de entrenamiento
        });
    </script>
</body>
</html>